# 🔧 修复 405 错误 - 完整指南

## 问题描述

用户报告的错误：
```json
{
  "timestamp": "2025-12-30T08:04:07.158+00:00",
  "status": 405,
  "error": "Method Not Allowed",
  "path": "/api/coze/run"
}
```

## 问题分析

### 关键信息

1. **path: "/api/coze/run"** 
   - ❌ 这说明应用仍在使用 Vite 代理路径
   - ✅ 应该使用完整 URL: `https://3mp9d3y2dz.coze.site/run`

2. **status: 405**
   - ❌ HTTP 方法不允许
   - 这是 Vite 代理返回的错误

### 根本原因

**缓存问题**：浏览器或 Vite 缓存了旧的代码，导致应用仍在使用代理路径。

---

## 🚀 解决方案

### 方案 1：强制清除所有缓存（推荐）

#### 步骤 1：停止开发服务器

在终端中按 `Ctrl + C` 停止当前运行的开发服务器。

#### 步骤 2：强制清除所有缓存

```bash
cd /workspace/app-8htx34d81fcx
./force-clear-cache.sh
```

这个脚本会：
- 停止所有 Node 进程
- 清除 Vite 缓存
- 清除 Taro 编译缓存
- 清除构建产物
- 清除 npm 缓存

#### 步骤 3：重启开发服务器

```bash
npm run dev:h5
```

等待编译完成，应该看到类似的日志：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔧 Vite 编译时环境变量注入
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
VITE_COZE_API_URL: ✅ 已设置
VITE_COZE_API_TOKEN: ✅ 已设置
最终使用的 URL: https://3mp9d3y2dz.coze.site/run
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 步骤 4：在浏览器中打开无痕窗口

**重要**：必须使用无痕窗口，避免浏览器缓存！

- **Chrome**: `Ctrl + Shift + N`
- **Firefox**: `Ctrl + Shift + P`
- **Edge**: `Ctrl + Shift + N`

#### 步骤 5：访问应用

在无痕窗口中访问：`http://localhost:10086`

#### 步骤 6：打开开发者工具

按 `F12` 打开开发者工具。

#### 步骤 7：检查控制台日志

切换到 **Console** 标签，应该看到：
```
🔗 使用完整 URL: https://3mp9d3y2dz.coze.site/run
```

如果看到这个日志，说明代码已经正确更新！

#### 步骤 8：检查网络请求

1. 切换到 **Network** 标签
2. 勾选 **Preserve log**（保留日志）
3. 点击"生成最佳参数"按钮
4. 查看请求列表，找到扣子 API 的请求
5. 检查请求 URL：
   - ✅ 应该是：`https://3mp9d3y2dz.coze.site/run`
   - ❌ 不应该是：`/api/coze/run`

#### 步骤 9：等待响应

- 正常响应时间：20-30 秒
- 状态码应该是：200 OK
- 如果成功，会自动跳转到参数展示页面

---

### 方案 2：使用独立 Web 应用（最简单）

如果方案 1 仍然不行，强烈建议使用独立 Web 应用：

```bash
# 1. 进入独立 Web 应用目录
cd /workspace/app-8htx34d81fcx/standalone-web

# 2. 启动本地服务器
python3 -m http.server 8000

# 3. 在浏览器中打开
# http://localhost:8000
```

**优势**：
- ✅ 无缓存问题
- ✅ 无代理问题
- ✅ 无构建步骤
- ✅ 调试简单
- ✅ 已修复所有已知问题

---

## 🔍 验证清单

请按照以下清单逐项检查：

### ✅ 1. 确认开发服务器已重启

- [ ] 已停止旧的开发服务器（Ctrl + C）
- [ ] 已执行 `./force-clear-cache.sh`
- [ ] 已执行 `npm run dev:h5`
- [ ] 看到编译成功的日志

### ✅ 2. 确认使用无痕窗口

- [ ] 已打开无痕窗口（Ctrl + Shift + N）
- [ ] 在无痕窗口中访问 `http://localhost:10086`
- [ ] 没有使用普通浏览器窗口

### ✅ 3. 确认控制台日志

打开开发者工具（F12）→ Console 标签：

- [ ] 看到日志：`🔗 使用完整 URL: https://3mp9d3y2dz.coze.site/run`
- [ ] 没有看到错误日志

### ✅ 4. 确认网络请求

打开开发者工具（F12）→ Network 标签：

- [ ] 勾选了 **Preserve log**
- [ ] 点击"生成最佳参数"按钮
- [ ] 看到请求 URL 是 `https://3mp9d3y2dz.coze.site/run`
- [ ] 没有看到请求 URL 是 `/api/coze/run`

### ✅ 5. 确认响应状态

- [ ] 状态码是 200 OK
- [ ] 响应时间约 20-30 秒
- [ ] 成功跳转到参数展示页面

---

## 🆘 如果问题仍然存在

### 情况 1：控制台日志仍然显示 `/api/coze/run`

**原因**：缓存没有完全清除

**解决方案**：
```bash
# 1. 停止开发服务器
# Ctrl + C

# 2. 手动删除所有缓存
rm -rf node_modules/.vite
rm -rf node_modules/.cache
rm -rf dist
rm -rf .taro-cache
rm -rf .temp

# 3. 重启开发服务器
npm run dev:h5

# 4. 关闭所有浏览器窗口
# 5. 重新打开无痕窗口
# 6. 访问 http://localhost:10086
```

### 情况 2：网络请求 URL 是正确的，但仍然返回错误

**原因**：可能是网络问题或 Token 问题

**解决方案**：
1. 检查网络连接
2. 检查 `.env` 文件中的 Token 是否正确
3. 使用独立 Web 应用（方案 2）

### 情况 3：无法启动开发服务器

**原因**：端口被占用或依赖问题

**解决方案**：
```bash
# 1. 停止所有 Node 进程
pkill -f "node"

# 2. 重新安装依赖
npm install

# 3. 重启开发服务器
npm run dev:h5
```

---

## 📝 需要提供的信息

如果问题仍然存在，请提供以下信息：

1. **控制台日志**
   - 打开开发者工具（F12）→ Console 标签
   - 复制所有日志（特别是包含 "🔗 使用" 的日志）

2. **网络请求详情**
   - 打开开发者工具（F12）→ Network 标签
   - 点击扣子 API 的请求
   - 复制以下信息：
     - Request URL
     - Request Method
     - Status Code
     - Request Headers（特别是 Authorization 头）
     - Response（如果有）

3. **截图**
   - 开发者工具的 Console 标签截图
   - 开发者工具的 Network 标签截图

4. **环境信息**
   - 操作系统：Windows / macOS / Linux
   - 浏览器：Chrome / Firefox / Edge
   - Node.js 版本：`node -v`
   - npm 版本：`npm -v`

---

## 🎯 最终建议

**如果 Taro H5 版本仍然有问题，强烈建议使用独立 Web 应用**：

```bash
cd /workspace/app-8htx34d81fcx/standalone-web
python3 -m http.server 8000
```

然后在浏览器中打开：`http://localhost:8000`

独立 Web 应用：
- ✅ 已修复所有已知问题
- ✅ 无需处理缓存问题
- ✅ 无需处理代理问题
- ✅ 调试简单
- ✅ 部署方便

---

**祝您使用愉快！📷✨**
