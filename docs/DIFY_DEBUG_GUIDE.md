# Dify API 调试指南

## 概述
已移除自动降级机制，API 调用失败时直接抛出错误，便于排查问题。

## 🔍 监控特性

### 1. 详细的控制台日志
每次 API 调用都会输出完整的日志信息，包括：

#### 请求日志
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📤 发送 Dify API 请求
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔗 URL: https://difyonline.58corp.com/v1/chat-messages
🔑 API Key: app-jGTNEtyl3MUvqJe...
📝 参数文本: 镜头：55mm，闪光灯：开启，场景：夜景人像，光线：夜晚，天气：晴天，风格：日系小清新
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 响应日志
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📥 Dify API 响应
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 状态码: 200
📦 响应数据: {
  "event": "message",
  "message_id": "...",
  "conversation_id": "...",
  "answer": "{\"iso\":400,...}"
}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 成功日志
```
✅ AI 返回内容: {"iso":400,"aperture":"f/1.8",...}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ AI 参数生成成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📸 生成的参数: {
  "iso": 400,
  "aperture": "f/1.8",
  "shutterSpeed": "1/60",
  ...
}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 错误日志
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ Dify API 调用异常
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ 错误类型: Error
❌ 错误信息: Dify API 请求失败，HTTP 状态码: 500
❌ 错误详情: Error: Dify API 请求失败，HTTP 状态码: 500
    at generateParamsWithAI (...)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2. 用户友好的错误提示
API 调用失败时，会显示模态对话框：

```
标题：Dify API 调用失败

内容：
错误信息：Dify API 请求失败，HTTP 状态码: 500

请检查：
1. 网络连接是否正常
2. API 配置是否正确
3. 查看控制台日志获取详细信息

[我知道了]
```

### 3. 参数收集日志
生成参数前会记录所有输入参数：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 开始生成参数
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 当前参数:
  - 镜头: 55mm
  - 闪光灯: 开启
  - 场景: portrait-night
  - 自定义场景: 无
  - 光线: night
  - 天气: sunny
  - 风格: japanese
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 🐛 常见错误场景

### 错误 1：配置缺失
**日志输出：**
```
❌ 配置错误: Dify API 配置缺失：请检查 .env 文件中的 TARO_APP_DIFY_API_URL 和 TARO_APP_DIFY_API_KEY
```

**原因：**
- .env 文件不存在
- 环境变量未正确配置
- 环境变量名称错误

**解决方法：**
1. 检查 .env 文件是否存在于项目根目录
2. 确认配置内容：
   ```env
   TARO_APP_DIFY_API_URL=https://difyonline.58corp.com/v1
   TARO_APP_DIFY_API_KEY=app-jGTNEtyl3MUvqJexDXmKlfK7
   ```
3. 重启开发服务器

### 错误 2：HTTP 状态码非 200
**日志输出：**
```
❌ 请求失败: Dify API 请求失败，HTTP 状态码: 500
❌ 响应内容: { error: "Internal Server Error" }
```

**原因：**
- Dify 服务器错误
- API Key 无效
- 请求格式错误

**解决方法：**
1. 检查 API Key 是否正确
2. 使用 curl 测试 API：
   ```bash
   curl -X POST 'https://difyonline.58corp.com/v1/chat-messages' \
     --header 'Authorization: Bearer app-jGTNEtyl3MUvqJexDXmKlfK7' \
     --header 'Content-Type: application/json' \
     --data-raw '{
       "inputs": {},
       "query": "测试",
       "response_mode": "blocking",
       "conversation_id": "",
       "user": "test"
     }'
   ```
3. 查看 Dify 服务状态

### 错误 3：响应数据无效
**日志输出：**
```
❌ 数据无效: Dify API 返回数据无效：缺少 answer 字段
❌ 实际返回: { event: "error", message: "..." }
```

**原因：**
- Dify 返回了错误响应
- 响应格式不符合预期

**解决方法：**
1. 查看完整的响应数据
2. 检查 Dify 工作流配置
3. 确认 response_mode 设置正确

### 错误 4：JSON 解析失败
**日志输出：**
```
❌ 解析失败: AI 返回的 JSON 格式无效或参数不完整
❌ 原始内容: 这是一段文本，不是 JSON
```

**原因：**
- AI 返回的不是 JSON 格式
- JSON 格式错误
- 缺少必需字段

**解决方法：**
1. 检查 Dify 工作流的输出格式
2. 确保 AI 返回严格的 JSON
3. 验证所有必需字段都存在

### 错误 5：网络超时
**日志输出：**
```
❌ 错误类型: Error
❌ 错误信息: request:fail timeout
❌ 错误详情: Error: request:fail timeout
```

**原因：**
- 网络连接慢
- Dify 服务响应慢
- 超时时间设置过短（当前 30 秒）

**解决方法：**
1. 检查网络连接
2. 重试请求
3. 如需要，增加超时时间

## 🔧 调试步骤

### 步骤 1：打开开发者工具
1. 启动微信开发者工具
2. 打开控制台（Console）
3. 清空之前的日志

### 步骤 2：触发 API 调用
1. 在小程序中选择参数
2. 点击"生成最佳参数"按钮
3. 观察控制台输出

### 步骤 3：分析日志
查看日志中的关键信息：

#### ✅ 成功的标志
- 看到 `📤 发送 Dify API 请求`
- 看到 `📥 Dify API 响应`
- 状态码为 200
- 看到 `✅ AI 参数生成成功`

#### ❌ 失败的标志
- 看到 `❌` 开头的错误日志
- 状态码不是 200
- 看到异常堆栈信息

### 步骤 4：查看网络请求
1. 切换到 Network 标签
2. 找到 `/chat-messages` 请求
3. 查看请求详情：
   - Request Headers
   - Request Payload
   - Response

### 步骤 5：验证配置
```bash
# 检查环境变量
cd /workspace/app-8htx34d81fcx
cat .env | grep DIFY

# 应该看到：
# TARO_APP_DIFY_API_URL=https://difyonline.58corp.com/v1
# TARO_APP_DIFY_API_KEY=app-jGTNEtyl3MUvqJexDXmKlfK7
```

## 📊 监控清单

### 请求前检查
- [ ] API URL 配置正确
- [ ] API Key 配置正确
- [ ] 参数文本构建正确
- [ ] 网络连接正常

### 请求中监控
- [ ] 请求已发送（看到 📤 日志）
- [ ] 请求参数正确
- [ ] Authorization 头正确

### 响应后检查
- [ ] 收到响应（看到 📥 日志）
- [ ] 状态码为 200
- [ ] 响应包含 answer 字段
- [ ] answer 是有效的 JSON
- [ ] JSON 包含所有必需字段

### 错误处理
- [ ] 错误被正确捕获
- [ ] 错误日志完整
- [ ] 用户看到错误提示
- [ ] 生成状态被重置

## 🎯 快速诊断

### 问题：点击按钮没反应
**检查：**
1. 控制台是否有任何日志？
2. 是否看到 `🚀 开始生成参数`？
3. 按钮是否被禁用（isGenerating 状态）？

### 问题：一直显示加载中
**检查：**
1. 是否有错误日志？
2. 是否超时（30 秒）？
3. 网络请求是否卡住？

### 问题：显示错误对话框
**检查：**
1. 对话框中的错误信息
2. 控制台中的详细日志
3. 网络请求的响应内容

## 📝 日志示例

### 完整的成功流程
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 开始生成参数
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 当前参数:
  - 镜头: 55mm
  - 闪光灯: 开启
  - 场景: portrait-night
  - 自定义场景: 无
  - 光线: night
  - 天气: sunny
  - 风格: japanese
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📤 发送 Dify API 请求
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔗 URL: https://difyonline.58corp.com/v1/chat-messages
🔑 API Key: app-jGTNEtyl3MUvqJe...
📝 参数文本: 镜头：55mm，闪光灯：开启，场景：夜景人像，光线：夜晚，天气：晴天，风格：日系小清新
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📥 Dify API 响应
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 状态码: 200
📦 响应数据: {
  "event": "message",
  "message_id": "abc123",
  "conversation_id": "def456",
  "answer": "{\"iso\":400,\"aperture\":\"f/1.8\",\"shutterSpeed\":\"1/60\",\"whiteBalance\":\"3200K\",\"sharpness\":2,\"contrast\":-1,\"saturation\":-1,\"tone\":1,\"flashMode\":\"TTL\",\"flashPower\":\"1/16\",\"flashAngle\":45,\"suggestion\":\"请使用 M 档，开启眼部对焦\"}"
}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ AI 返回内容: {"iso":400,"aperture":"f/1.8",...}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ AI 参数生成成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📸 生成的参数: {
  "iso": 400,
  "aperture": "f/1.8",
  "shutterSpeed": "1/60",
  "whiteBalance": "3200K",
  "sharpness": 2,
  "contrast": -1,
  "saturation": -1,
  "tone": 1,
  "flashMode": "TTL",
  "flashPower": "1/16",
  "flashAngle": 45,
  "suggestion": "请使用 M 档，开启眼部对焦"
}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 完整的失败流程
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 开始生成参数
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 当前参数:
  - 镜头: 55mm
  - 闪光灯: 开启
  - 场景: portrait-night
  - 自定义场景: 无
  - 光线: night
  - 天气: sunny
  - 风格: japanese
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📤 发送 Dify API 请求
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔗 URL: https://difyonline.58corp.com/v1/chat-messages
🔑 API Key: app-jGTNEtyl3MUvqJe...
📝 参数文本: 镜头：55mm，闪光灯：开启，场景：夜景人像，光线：夜晚，天气：晴天，风格：日系小清新
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📥 Dify API 响应
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 状态码: 500
📦 响应数据: {
  "error": "Internal Server Error"
}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ 请求失败: Dify API 请求失败，HTTP 状态码: 500
❌ 响应内容: { error: "Internal Server Error" }
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ Dify API 调用异常
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ 错误类型: Error
❌ 错误信息: Dify API 请求失败，HTTP 状态码: 500
❌ 错误详情: Error: Dify API 请求失败，HTTP 状态码: 500
    at generateParamsWithAI (difyApi.ts:166)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ 参数生成失败
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ 错误信息: Dify API 请求失败，HTTP 状态码: 500
❌ 错误堆栈: Error: Dify API 请求失败，HTTP 状态码: 500
    at generateParamsWithAI (difyApi.ts:166)
    at generateParams (cameraStore.ts:134)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[用户看到错误对话框]
标题：Dify API 调用失败
内容：错误信息：Dify API 请求失败，HTTP 状态码: 500

请检查：
1. 网络连接是否正常
2. API 配置是否正确
3. 查看控制台日志获取详细信息
```

## 🎓 总结

### 监控优势
1. **完整的日志链路**：从请求到响应的每一步都有记录
2. **清晰的错误信息**：错误类型、错误信息、错误堆栈一目了然
3. **用户友好提示**：错误对话框提供排查建议
4. **便于调试**：所有关键信息都在控制台中

### 调试建议
1. **始终查看控制台**：所有关键信息都在日志中
2. **关注错误标志**：看到 ❌ 立即查看详细信息
3. **验证配置**：确保 API URL 和 Key 正确
4. **测试网络**：使用 curl 直接测试 API
5. **检查响应**：确认 Dify 返回的数据格式正确

---

✨ 现在可以清晰地看到 Dify API 的调用情况和错误详情！
