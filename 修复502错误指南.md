# 🔧 修复 502 错误 - 使用指南

## ✅ 问题已解决！

经过测试，发现之前的 502 错误是因为使用了错误的 API Token。

### 测试结果

```bash
# 使用正确的 JWT Token 测试
curl -X POST https://3mp9d3y2dz.coze.site/run \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -d '{"input_text":"..."}' \
  --max-time 30

# 结果
✅ 状态码: 200
✅ 响应时间: 24.242988秒
✅ API 调用成功！
```

### 关键发现

1. **扣子 API 支持跨域请求**：无需使用代理或 CORS 代理
2. **响应时间较长**：约 20-30 秒，这是正常的（AI 生成需要时间）
3. **Token 格式**：必须使用 JWT Token（在 `.env` 文件中），而不是 `pat_` 开头的 Token

---

## 🚀 使用方法（Taro H5 版本）

### 步骤 1：清除缓存

```bash
cd /workspace/app-8htx34d81fcx
./clear-cache.sh
```

### 步骤 2：重启开发服务器

```bash
npm run dev:h5
```

### 步骤 3：强制刷新浏览器

- Windows/Linux: Ctrl + Shift + R
- Mac: Cmd + Shift + R

### 步骤 4：测试参数生成

1. 选择参数：
   - 镜头：RF 55mm f/1.8
   - 闪光灯：开启
   - 场景：夜景人像
   - 光线：黄金时刻
   - 天气：晴天
   - 风格：日系小清新

2. 点击"生成最佳参数"按钮

3. **等待约 20-30 秒**（这是正常的！AI 生成需要时间）

4. 应该成功跳转到参数展示页面

---

## 🌟 替代方案：使用独立 Web 应用（推荐）

我已经为您创建了一个完全独立的纯前端 Web 应用，不依赖 Taro 框架，可以完美运行！

**位置**：`standalone-web/` 目录

**使用方法**：

```bash
# 进入目录
cd standalone-web

# 启动本地服务器
python3 -m http.server 8000

# 在浏览器中打开
# http://localhost:8000
```

**优势**：
- ✅ 无框架依赖，加载快速
- ✅ 无构建步骤，开发简单
- ✅ 无 CORS 问题
- ✅ 调试简单
- ✅ 部署方便（可部署到 Vercel、Netlify、GitHub Pages 等）
- ✅ 所有功能完整实现

**详细说明**：请查看 `standalone-web/README.md`

---

## 📝 技术说明

### 为什么之前会出现 502 错误？

1. **错误的 Token**
   - 之前使用的是 `pat_tCvXZJZRdqVJXQNYGLXvJDhxPNfvXFvCxfqBEGPEFKGVlqEXqPqJxDUGqvLvmFZf`
   - 这个 Token 无效或权限不足
   - 正确的 Token 在 `.env` 文件中（JWT 格式）

2. **Vite 代理问题**
   - Vite 代理可能因为超时而返回 502
   - 扣子 API 响应时间较长（约 24 秒）
   - Vite 代理默认超时时间可能不够

3. **解决方案**
   - 直接调用扣子 API（不使用代理）
   - 扣子 API 支持跨域请求
   - 使用正确的 JWT Token

### 为什么不需要代理？

扣子 API 已经配置了 CORS 头部：
```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
```

因此浏览器不会阻止跨域请求。

### 响应时间说明

扣子 API 响应时间约 20-30 秒，这是正常的：
- AI 模型需要时间生成参数
- 包含多个参数维度（相机设置、闪光灯设置、照片风格等）
- 需要根据输入条件进行智能分析

---

## 🆘 常见问题

### 问题 1：请求超时

**原因**：网络连接不稳定或 API 响应时间过长

**解决方案**：
1. 检查网络连接
2. 增加超时时间（已设置为 30 秒）
3. 重试请求

### 问题 2：403 错误

**原因**：Token 无效或权限不足

**解决方案**：
1. 确认使用正确的 JWT Token（在 `.env` 文件中）
2. 检查 Token 是否过期
3. 联系 API 提供方更新 Token

### 问题 3：仍然出现 502 错误

**原因**：可能是其他原因导致的

**解决方案**：
1. 查看浏览器控制台的详细错误信息
2. 查看网络请求的详细信息
3. 使用独立 Web 应用（`standalone-web/` 目录）

---

## 🎉 总结

✅ Taro H5 版本已修复：直接调用扣子 API，无需代理
✅ 独立 Web 应用已创建：无框架依赖，更稳定
✅ 详细文档已提供：TODO.md

**我的建议**：

如果您想快速测试：
→ 使用 Taro H5 版本（清除缓存 → 重启服务器 → 强制刷新浏览器）

如果您想要稳定可靠的方案：
→ 使用独立 Web 应用（强烈推荐）

如果您想要部署到生产环境：
→ 必须使用独立 Web 应用

---

**享受摄影的乐趣！📷✨**
